<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quản lý đơn hàng - Bloom</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
    rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/detail.css">
  <link rel="stylesheet" href="assets/css/admin.css">

</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar">
      <div class="bloom-logo" aria-label="Bloom - Trở về trang chủ">
        <svg class="logo-icon" viewBox="0 0 100 100" fill="none" aria-hidden="true">
          <circle cx="50" cy="50" r="45" fill="#2e7d68" opacity="0.9" />
          <path d="M50 20 C60 15, 75 25, 75 40 C75 55, 60 65, 50 70 C40 65, 25 55, 25 40 C25 25, 40 15, 50 20"
            fill="#eaf8f0" />
          <circle cx="40" cy="35" r="8" fill="#b19cd9" />
          <circle cx="60" cy="35" r="8" fill="#b19cd9" />
          <circle cx="50" cy="50" r="12" fill="#9370db" />
          <path d="M50 70 L45 85 L55 85 Z" fill="#2e7d68" />
        </svg>
        <span>Bloom</span>
      </div>
      <a href="0_dashboard.html"><i class="fa-sharp fa-solid fa-house"></i></i> Tổng quan</a>
      <a href="1_users.html"><i class="fa-solid fa-users me-2"></i>Quản lý khách hàng</a>
      <a href="2_products.html"><i class="fa-solid fa-bread-slice me-2"></i>Quản lý sản phẩm</a>
      <a href="3_category.html"><i class="fa-solid fa-folder-tree me-2"></i>Quản lý danh mục</a>
      <a href="4_price.html"><i class="fa-regular fa-money-bill-1"></i> Quản lý giá bán</a>
      <a href="5_orders.html" class="active"><i class="fa-regular fa-rectangle-list"></i> Quản lý đơn hàng</a>
      <a href="6_inputproduct.html"><i class="fa-regular fa-pen-to-square"></i> Quản lý nhập hàng</a>
      <a href="7_inventory.html"><i class="fa-solid fa-boxes-stacked me-2"></i> Quản lý tồn kho</a>
      <div class="logout_admin"><a href="index.html" id="logout-link">Đăng xuất</a></div>
      <script>
        document.getElementById("logout-link").addEventListener("click", function (event) {
          event.preventDefault(); // Ngăn chặn chuyển trang ngay lập tức
          const confirmLogout = confirm("Bạn có chắc chắn muốn đăng xuất không?");

          if (confirmLogout) {
            window.location.href = this.href; // Chuyển đến trang đăng xuất nếu xác nhận
          }
        });
      </script>
    </div>
  </div>
  <!-- Main Content -->
  <div class="main-content">
    <!-- header  -->
    <div class="header">
      <div class="header__title"><i class="fa-regular fa-rectangle-list"></i> Quản lý đơn hàng</div>
      <div class="header__info">
        <div>
          <span class="text-muted small">Xin chào, Admin</span>
          <a href="javascript:void(0)" id="userMenuToggle">
            <i class="fa-solid fa-user-tie ms-2"></i>
          </a>
        </div>
        <!-- Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
          <div class="dropdown-header">
            <div class="user-name">Admin User</div>
            <div class="user-role">Quản trị viên</div>
            <span>_________________________________________________</span>
          </div>
          <ul class="dropdown-menu">
            <li>
              <a href="#" class="dropdown-item">
                <i class="fa-solid fa-user"></i>
                <span>Hồ sơ cá nhân</span>
              </a>
            </li>
            <li>
              <a href="#" class="dropdown-item">
                <i class="fa-solid fa-gear"></i>
                <span>Cài đặt</span>
              </a>
            </li>
            <li class="dropdown-divider"></li>
            <li>
              <button class="dropdown-item logout" id="logoutBtn">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Đăng xuất</span>
              </button>
            </li>
          </ul>
        </div>
        <!-- Overlay -->
        <div class="dropdown-overlay" id="dropdownOverlay"></div>
      </div>
    </div>

    <div class="container-fluid" data-aos="fade-up">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="date-filter-container">
          <input type="date" id="filterDateFrom" class="form-control" style="width: 150px;">
          <span class="date-filter-separator">→</span>
          <input type="date" id="filterDateTo" class="form-control" style="width: 150px;">
        </div>
        <!-- Nút tìm kiếm -->
        <button class="search-btn" id="searchButton">
          <i class="fa-solid fa-magnifying-glass"></i>
          Tìm
        </button>
        <script>
          document.getElementById('searchButton').addEventListener('click', function () {
              alert("Đang hiển thị danh sách bạn cần tìm.")
            });
        </script>
        <style>
          .date-filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
          }

          .date-filter-separator {
            color: #6c757d;
            font-weight: bold;
          }

          .search-btn {
            background: linear-gradient(135deg, #2e7d68 0%, #349b7f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            margin-right: 20px;
          }

          .search-btn:hover {
            background: linear-gradient(135deg, #349b7f 0%, #2e7d68 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 104, 0.3);
          }
        </style>
        <div class="d-flex gap-2">
          <input id="searchOrder" class="form-control" placeholder="Tìm kiếm theo mã hoặc khách hàng...">
          <select id="filterStatus" class="form-select" style="width: 400px;">
            <option value="">Tất cả trạng thái</option>
            <option value="Chờ xử lý">Chờ xử lý</option>
            <option value="Đang giao">Đang giao</option>
            <option value="Hoàn thành">Hoàn thành</option>
            <option value="Hủy">Hủy</option>
          </select>
        </div>
        

        <!-- Nút reload -->
        <button class="search-btn" id="reloadButton"
          style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
          <i class="fa-solid fa-rotate-right"></i>
          Đặt lại
        </button>
        <script>
          document.getElementById('reloadButton').addEventListener('click', function () {
              location.reload();
            });
        </script>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle text-center">
              <thead class="table-light">
                <tr>
                  <th>Mã đơn</th>
                  <th>Khách hàng</th>
                  <th>Ngày đặt</th>
                  <th>Địa chỉ</th>
                  <th>Sản phẩm</th>
                  <th>Tổng tiền (VNĐ)</th>
                  <th>Trạng thái</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="orderTableBody"></tbody>
            </table>
            <ul id="pagination">
              </li>
              <li class="pagination-item">
                <a href="5_orders.html" class="pagination-item__link active">1</a>
              </li>
              <li class="pagination-item">
                <a href="5_orders.html" class="pagination-item__link " target="_self">2</a>
              </li>
              <li class="pagination-item">
                <a href="5_orders.html" class="pagination-item__link " target="_self">3</a>
              </li>
              <li class="pagination-item">
                <a href="5_orders.html" class="pagination-item__link " target="_self">4</a>
              </li>
              <li class="pagination-item">
                <a href="5_orders.html" class="pagination-item__link " target="_self">5</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <footer class="mt-4">
        <p class="text-center text-muted">&copy; 2024 Bloom - Shop hoa tươi. All rights reserved.</p>
      </footer>
    </div>


    <!-- Modal Bill Tĩnh -->
    <div class="modal fade" id="staticBillModal" tabindex="-1" aria-labelledby="staticBillModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chi tiết đơn hàng #<span id="orderId"></span></h5>
            <button type="button" class="modal-close" data-bs-dismiss="modal" aria-label="Close">&times;</button>
          </div>
          <div class="modal-body">
            <!-- Nội dung modal giữ nguyên -->
            <div class="order-detail-section">
              <div class="section-title">Thông tin đơn hàng</div>
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">Mã đơn hàng</div>
                  <div class="detail-value" id="detailOrderId">DH001</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Ngày đặt</div>
                  <div class="detail-value" id="detailOrderDate">15/01/2024</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Trạng thái</div>
                  <div class="detail-value"><span class="status-badge status-delivered">Đã giao</span></div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Tổng tiền</div>
                  <div class="detail-value" id="detailTotalAmount">12,500,000 ₫</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Phương thức thanh toán</div>
                  <div class="detail-value" id="detailPaymentMethod">Chuyển khoản</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Ghi chú</div>
                  <div class="detail-value" id="detailNotes">Giao hàng giờ hành chính</div>
                </div>
              </div>
            </div>

            <div class="order-detail-section">
              <div class="section-title">Thông tin khách hàng</div>
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">Họ tên</div>
                  <div class="detail-value" id="detailCustomerName">Nguyễn Văn A</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Số điện thoại</div>
                  <div class="detail-value" id="detailCustomerPhone">0901234567</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Email</div>
                  <div class="detail-value" id="detailCustomerEmail">nguyenvana@email.com</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Địa chỉ</div>
                  <div class="detail-value" id="detailCustomerAddress">860/57 Huỳnh Tấn Phát, Khu phố 3, Phường Tân Mỹ,
                    TP Hồ Chí Minh</div>
                </div>
              </div>
            </div>

            <div class="order-detail-section">
              <div class="section-title">Sản phẩm đã đặt</div>
              <table class="product-table">
                <thead>
                  <tr>
                    <th>Hình ảnh</th>
                    <th>Sản phẩm</th>
                    <th>Đơn giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Nội dung sản phẩm sẽ được thêm bằng JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn-modal-save btn-primary" onclick="printInvoice()">
              <i class="fa-solid fa-print me-2"></i>In hóa đơn
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080" id="toastContainer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
      AOS.init();

      let orders = [
        {
          code: 'DH001',
          customer: 'Nguyễn Văn A',
          date: '2025-10-14',
          address: '11 Hòa Hao Q10 HCM',
          products: [{ name: 'Peach', quantity: 1, price: 770000 }, { name: 'Nhiệt ái', quantity: 1, price: 700000 }],
          total: 1470000,
          status: 'Chờ xử lý'
        },
        {
          code: 'DH002',
          customer: 'Trần Thị B',
          date: '2025-10-21',
          address: '53 Nguyễn Thái Học, Huế',
          products: [{ name: 'Lẵng hoa sinh nhật', quantity: 1, price: 350000 }],
          total: 350000,
          status: 'Đang giao'
        },
        {
          code: 'DH003',
          customer: 'Đoàn Thị H',
          date: '2025-10-22',
          address: '85 Trường Chinh, TP.HCM',
          products: [{ name: 'Tương lai', quantity: 1, price: 2100000 },
          { name: 'BlueSky', quantity: 1, price: 1450000 },
          { name: 'Hồng Phát', quantity: 1, price: 1900000 }
          ],
          total: 5400000,
          status: 'Chờ xử lý'
        },
        {
          code: 'DH004',
          customer: 'Hàng Văn B',
          date: '2025-10-22',
          address: '31 Lê Thánh Tôn, Nha Trang',
          products: [{ name: 'BlueBerry', quantity: 4, price: 2100000 },
          ],
          total: 8400000,
          status: 'Đang giao'
        },
        {
          code: 'DH005',
          customer: 'Nguyễn Thị L',
          date: '2025-10-21',
          address: '64 Nguyễn Huệ, Quy Nhơn',
          products: [{ name: 'Sen Xanh', quantity: 1, price: 900000 }
          ],
          total: 900000,
          status: 'Hoàn thành'
        },
        {
          code: 'DH006',
          customer: 'Lê Văn C',
          date: '2025-10-20',
          address: '29 Hòa Bình, Biên Hòa',
          products: [{ name: 'Peach', quantity: 1, price: 770000 },
          ],
          total: 770000,
          status: 'Đang giao'
        },
        {
          code: 'DH007',
          customer: 'Lê Văn C',
          date: '2025-10-24',
          address: '17 Lạc Long Quân, TP.HCM',
          products: [{ name: 'Bluberry', quantity: 1, price: 250000 },
          { name: 'Lemon', quantity: 2, price: 1300000 }
          ],
          total: 2850000,
          status: 'Đang giao'
        }
      ];

      const tbody = document.getElementById('orderTableBody');
      const staticBillModalEl = document.getElementById('staticBillModal');
      const staticBillModal = new bootstrap.Modal(staticBillModalEl);

      // -------------------- TOAST --------------------
      function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const bgColor = type === 'success' ? 'bg-success' :
          type === 'error' ? 'bg-danger' : 'bg-warning';
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white border-0 ${bgColor}`;
        toast.role = 'alert';
        toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { delay: 2000 });
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', () => toast.remove());
      }

      // -------------------- RENDER BẢNG --------------------
      function renderTable(data) {
        tbody.innerHTML = '';
        data.forEach((o, i) => {
          const productSummary = o.products.map(p => `${p.name} x${p.quantity}`).join(', ');

          // Nếu trạng thái là 'Hoàn thành', dropdown sẽ bị disable
          const disableStatus = o.status === 'Hoàn thành' || o.status === 'Hủy' ? 'disabled' : '';

          tbody.innerHTML += `
      <tr>
        <td>${o.code}</td>
        <td>${o.customer}</td>
        <td>${o.date}</td>
        <td style="width: 200px;">${o.address}</td>
        <td style="width: 250px;">${productSummary}</td>
        <td>${o.total.toLocaleString()}</td>
        <td>
          <select class="form-select form-select-sm status-select" data-index="${i}" ${disableStatus}>
            <option value="Chờ xử lý" ${o.status === 'Chờ xử lý' ? 'selected' : ''}>Chờ xử lý</option>
            <option value="Đang giao" ${o.status === 'Đang giao' ? 'selected' : ''}>Đang giao</option>
            <option value="Hoàn thành" ${o.status === 'Hoàn thành' ? 'selected' : ''}>Hoàn thành</option>
            <option value="Hủy" ${o.status === 'Hủy' ? 'selected' : ''}>Hủy</option>
          </select>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-info invoice-btn" data-index="${i}">
            <i class="fa-solid fa-file-invoice"></i> 
          </button>
        </td>
      </tr>
    `;
        });
      }

      renderTable(orders);

      // -------------------- CẬP NHẬT TRẠNG THÁI --------------------
      tbody.addEventListener('change', e => {
        const select = e.target.closest('.status-select');
        if (select) {
          const index = Number(select.dataset.index);
          orders[index].status = select.value;
          showToast(`Cập nhật trạng thái đơn ${orders[index].code} thành công!`);
        }
      });

      // -------------------- XUẤT HÓA ĐƠN --------------------
      // -------------------- XUẤT HÓA ĐƠN --------------------
      tbody.addEventListener('click', e => {
        const btnInvoice = e.target.closest('.invoice-btn');
        if (!btnInvoice) return;

        const index = Number(btnInvoice.dataset.index);
        const order = orders[index];

        // Validate order tồn tại
        if (!order) {
          console.error('Order not found at index:', index);
          return;
        }

        renderInvoice(order);
        staticBillModal.show();
      });

      function renderInvoice(order) {
        // Thông tin đơn hàng
        setTextContent('orderId', order.code);
        setTextContent('detailOrderId', order.code);
        setTextContent('detailOrderDate', formatDate(order.date));
        setTextContent('detailTotalAmount', formatCurrency(order.total));
        setTextContent('detailPaymentMethod', order.paymentMethod || 'Tiền mặt');
        setTextContent('detailNotes', order.notes || 'Giao hàng giờ hành chính');

        // Trạng thái
        renderOrderStatus(order.status);

        // Thông tin khách hàng
        setTextContent('detailCustomerName', order.customer);
        setTextContent('detailCustomerPhone', order.phone || '0976854263');
        setTextContent('detailCustomerEmail', order.email || 'nguyenvana@gmail.com');
        setTextContent('detailCustomerAddress', order.address);

        // Sản phẩm đã đặt
        renderOrderProducts(order.products);
      }

      function setTextContent(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = text;
        }
      }

      function formatCurrency(amount) {
        return amount.toLocaleString('vi-VN') + ' ₫';
      }

      function formatDate(dateString) {
        // Có thể thêm logic format date nếu cần
        return dateString;
      }

      function renderOrderStatus(status) {
        const statusBadge = document.querySelector('#staticBillModal .status-badge');
        if (!statusBadge) return;

        statusBadge.textContent = status;
        statusBadge.className = `status-badge status-${status.replace(/\s/g, '').toLowerCase()}`;
      }

      // -------------------- XUẤT HÓA ĐƠN --------------------
      tbody.addEventListener('click', e => {
        const btnInvoice = e.target.closest('.invoice-btn');
        if (btnInvoice) {
          const index = Number(btnInvoice.dataset.index);
          const order = orders[index];

          // Hiển thị modal
          staticBillModal.show();
        }
      });
      /* ==================== HÀM RANDOM ẢNH ==================== */


     /* ==================== HÀM RANDOM ẢNH ==================== */
function getRandomProductImage() {
  const productImages = [
    '../images/hoa1.jpg',
    '../images/hoa2.jpg',
    '../images/hoa3.jpg',
    '../images/hoa4.jpg',
    '../images/langhoa1.webp',
    '../images/langhoa2.jpg',
    '../images/langhoa3.png',
    '../images/kehoa1.jpg',
    '../images/kehoa2.jpg',
    '../images/kehoa3.jpg'
  ];
  
  const randomIndex = Math.floor(Math.random() * productImages.length);
  return productImages[randomIndex];
}

function renderOrderProducts(products) {
  const productTableBody = document.querySelector('#staticBillModal .product-table tbody');
  if (!productTableBody) return;

  productTableBody.innerHTML = '';

  products.forEach(product => {
    // Gán ảnh random cho mỗi sản phẩm
    const randomImage = getRandomProductImage();
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <img src="${randomImage}" alt="${product.name}" 
             style="width:50px;height:auto;object-fit:cover;">
      </td>
      <td>${escapeHtml(product.name)}</td>
      <td>${formatCurrency(product.price)}</td>
      <td>${product.quantity}</td>
      <td>${formatCurrency(product.price * product.quantity)}</td>
    `;
          productTableBody.appendChild(row);
          
        });
      }

      function getProductImage(product) {
        // Có thể mở rộng để lấy ảnh từ product object
        return product.image || '../assets/img/hoa/1.jpg';
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

     

      // -------------------- IN HÓA ĐƠN --------------------
      document.querySelector('#staticBillModal .btn-primary').addEventListener('click', () => {
        showToast('In hóa đơn thành công!');
      });
      const pagination = document.getElementById('pagination');
      pagination.addEventListener('click', e => {
        if (e.target.classList.contains('pagination-item__link')) {
          e.preventDefault();
          const currentActive = pagination.querySelector('.pagination-item__link.active');
          if (currentActive) currentActive.classList.remove('active');
          e.target.classList.add('active');
        }
      });
    </script>
    <script src="assets/js/info_admin.js"></script>
</body>

</html>