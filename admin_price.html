<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>QU·∫¢N L√ç GI√Å B√ÅN V√Ä L·ª¢I NHU·∫¨N</title>
    <link rel="stylesheet" href="css/price.css" />
    <script
      src="https://kit.fontawesome.com/a076d05399.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <header>
      <a href="admin_home.html" class="home-link"
        ><i class="fas fa-home"></i> Trang Ch·ªß ADMIN
      </a>
    </header>

    <main>
      <h2><i class="fas fa-coins"></i> QU·∫¢N L√ç GI√Å B√ÅN V√Ä L·ª¢I NHU·∫¨N</h2>

      <div class="filter-section">
        <label for="category">DANH M·ª§C</label>
        <select id="category" onchange="filterCategory()">
          <option value="all">Hi·ªán t·∫•t c·∫£</option>
          <option value="hoa">Hoa</option>
          <option value="langhoa">L·∫µng hoa</option>
          <option value="kehoa">K·ªá hoa</option>
          <option value="giohoa">Gi·ªè hoa</option>
        </select>
        <button id="editBtn" onclick="openEditPopup()">
          <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
        </button>
      </div>

      <table id="priceTable">
        <thead>
          <tr>
            <th>STT</th>
            <th>M√£ s·∫£n ph·∫©m</th>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>Gi√° v·ªën</th>
            <th>Gi√° b√°n</th>
            <th>L·ª£i nhu·∫≠n</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <section id="history">
        <h3><i class="fas fa-scroll"></i> L·ªãch s·ª≠ ch·ªânh s·ª≠a</h3>
        <ul id="historyList"></ul>
      </section>
    </main>

    <div id="editPopup" class="popup">
      <div class="popup-content">
        <h3><i class="fas fa-pen"></i> Ch·ªânh s·ª≠a gi√° s·∫£n ph·∫©m</h3>

        <label>M√£ s·∫£n ph·∫©m:</label>
        <input type="text" id="productCode" placeholder="VD: P001" />

        <label>T√™n s·∫£n ph·∫©m:</label>
        <input
          type="text"
          id="productName"
          readonly
          style="background-color: #f0f0f0"
        />

        <label>Gi√° v·ªën (VND):</label>
        <input type="number" id="costPrice" placeholder="60000" />

        <label>Gi√° b√°n (VND):</label>
        <input type="number" id="sellPrice" placeholder="78000" />

        <label>L·ª£i nhu·∫≠n (%):</label>
        <input
          type="text"
          id="profitPercent"
          readonly
          style="background-color: #f0f0f0; font-weight: bold"
        />

        <div class="popup-actions">
          <button onclick="saveEdit()"><i class="fas fa-check"></i> L∆∞u</button>
          <button onclick="closePopup()">
            <i class="fas fa-times"></i> H·ªßy
          </button>
        </div>
      </div>
    </div>

    <div id="overlay" class="overlay" onclick="closeCustomAlert()"></div>
    <div id="customAlert" class="custom-alert">
      <p id="alertMessage">N·ªôi dung th√¥ng b√°o...</p>
      <button onclick="closeCustomAlert()">OK</button>
    </div>

    <script src="js/price.js"></script>

    <script>
      // L∆∞u √Ω: C√°c h√†m saveEdit() v√† calculateProfit() ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang js/price.js
      // H√†m calculateProfit (t√≠nh l·ª£i nhu·∫≠n) c·∫ßn ph·∫£i ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong js/price.js ƒë·ªÉ ƒëo·∫°n n√†y ho·∫°t ƒë·ªông.

      document.addEventListener("DOMContentLoaded", () => {
        // data v√† renderTable ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong js/price.js
        renderTable(data);
        loadHistory();
      });

      // üîπ L∆∞u l·ªãch s·ª≠ ch·ªânh s·ª≠a v√†o localStorage
      function addHistory(product, oldCost, oldSell) {
        let history = JSON.parse(localStorage.getItem("editHistory")) || [];
        const time = new Date().toLocaleString("vi-VN");

        // S·ª≠ d·ª•ng h√†m calculateProfit t·ª´ js/price.js
        // N·∫øu b·∫°n ch∆∞a c√≥ h√†m n√†y trong js/price.js, n√≥ c·∫ßn ƒë∆∞·ª£c th√™m v√†o.
        const profit = calculateProfit(product.cost, product.sell);

        history.unshift({
          id: product.id,
          name: product.name,
          oldCost: oldCost,
          oldSell: oldSell,
          newCost: product.cost,
          newSell: product.sell,
          profit: profit,
          time: time,
        });

        localStorage.setItem("editHistory", JSON.stringify(history));
        displayHistory();
      }

      // üîπ Hi·ªÉn th·ªã l·ªãch s·ª≠ ra giao di·ªán
      function displayHistory() {
        const historyList = document.getElementById("historyList");
        const history = JSON.parse(localStorage.getItem("editHistory")) || [];
        historyList.innerHTML = "";

        if (history.length === 0) {
          historyList.innerHTML = "<li>Ch∆∞a c√≥ l·ªãch s·ª≠ ch·ªânh s·ª≠a n√†o.</li>";
          return;
        }

        history.forEach((item, index) => {
          const li = document.createElement("li");
          li.style.marginBottom = "8px";
          li.innerHTML = `
            <strong>${index + 1}.</strong> 
            <b>${item.name}</b> (${item.id})<br>
            Gi√° v·ªën: ${Number(
              item.oldCost
            ).toLocaleString()} ‚Üí <b style="color:green">${Number(
            item.newCost
          ).toLocaleString()}</b> VND<br>
            Gi√° b√°n: ${Number(
              item.oldSell
            ).toLocaleString()} ‚Üí <b style="color:green">${Number(
            item.newSell
          ).toLocaleString()}</b> VND<br>
            L·ª£i nhu·∫≠n m·ªõi: <b>${item.profit}%</b><br>
            <small style="color:gray">${item.time}</small>
          `;
          historyList.appendChild(li);
        });
      }

      // üîπ T·∫£i l·ªãch s·ª≠ khi load trang
      function loadHistory() {
        displayHistory();
      }

      // ƒê√É X√ìA LOGIC GHI ƒê√à H√ÄM saveEdit() G·ªêC ·ªû ƒê√ÇY.
      // H√†m saveEdit() m·ªõi v·ªõi logic ki·ªÉm tra th√¥ng b√°o s·∫Ω n·∫±m trong js/price.js.
    </script>
  </body>
</html>
